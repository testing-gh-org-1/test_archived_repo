package com.example.demo;

import java.io.*;
import javax.servlet.http.HttpServletRequest;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

// CWE-400: Uncontrolled Resource Consumption
// CWE-404: Improper Resource Shutdown or Release
public class ResourceManagementVulnerability {
    
    // CWE-404: Resource leak - file not closed
    public String readFileWithoutClosing(String filename) {
        try {
            // Vulnerable: file reader never closed
            BufferedReader reader = new BufferedReader(new FileReader(filename));
            return reader.readLine();
        } catch (IOException e) {
            return null;
        }
    }
    
    // CWE-404: Database connection not closed
    public void queryDatabaseWithLeak() {
        try {
            java.sql.Connection conn = java.sql.DriverManager.getConnection("jdbc:mysql://localhost/db", "user", "pass");
            java.sql.Statement stmt = conn.createStatement();
            // Vulnerable: connection and statement never closed
            stmt.executeQuery("SELECT * FROM users");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // CWE-400: Unbounded loop
    public void processUserInput(String input) {
        // Vulnerable: loop count controlled by user
        int count = Integer.parseInt(input);
        for (int i = 0; i < count; i++) {
            // Expensive operation
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    
    // CWE-400: Unbounded memory allocation
    public byte[] allocateMemory(HttpServletRequest request) {
        String size = request.getParameter("size");
        // Vulnerable: user controls memory allocation size
        int bytes = Integer.parseInt(size);
        return new byte[bytes];
    }
    
    // CWE-400: ZIP bomb vulnerability
    public void extractZip(InputStream zipStream) {
        try {
            ZipInputStream zis = new ZipInputStream(zipStream);
            ZipEntry entry;
            // Vulnerable: no size limit check
            while ((entry = zis.getNextEntry()) != null) {
                byte[] buffer = new byte[1024];
                FileOutputStream fos = new FileOutputStream("/tmp/" + entry.getName());
                int len;
                while ((len = zis.read(buffer)) > 0) {
                    fos.write(buffer, 0, len);
                }
                fos.close();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    // CWE-404: InputStream not closed
    public void readStream(InputStream input) {
        try {
            // Vulnerable: stream never closed
            byte[] buffer = new byte[1024];
            input.read(buffer);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    // CWE-400: Regex DoS (ReDoS)
    public boolean validateInput(String input) {
        // Vulnerable: catastrophic backtracking possible
        return input.matches("(a+)+b");
    }
    
    // CWE-400: Uncontrolled recursion
    public int recursiveFunction(int n) {
        // Vulnerable: no depth limit
        if (n <= 0) return 1;
        return n * recursiveFunction(n - 1);
    }
}
