package com.example.demo;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;

// CWE-601: URL Redirection to Untrusted Site ('Open Redirect')
public class OpenRedirectVulnerability {
    
    // CWE-601: Unvalidated redirect
    public void redirect(HttpServletRequest request, HttpServletResponse response) throws IOException {
        String url = request.getParameter("url");
        // Vulnerable: redirecting to user-controlled URL
        response.sendRedirect(url);
    }
    
    // CWE-601: Open redirect after login
    public void loginRedirect(HttpServletRequest request, HttpServletResponse response) throws IOException {
        String returnUrl = request.getParameter("returnUrl");
        HttpSession session = request.getSession();
        
        // Authenticate user
        session.setAttribute("authenticated", true);
        
        // Vulnerable: redirecting to user-specified URL
        if (returnUrl != null) {
            response.sendRedirect(returnUrl);
        }
    }
    
    // CWE-601: Meta refresh redirect
    public void metaRefreshRedirect(HttpServletResponse response, String targetUrl) throws IOException {
        // Vulnerable: meta refresh to user-controlled URL
        response.setContentType("text/html");
        response.getWriter().println("<html><head>");
        response.getWriter().println("<meta http-equiv='refresh' content='0;url=" + targetUrl + "'>");
        response.getWriter().println("</head></html>");
    }
    
    // CWE-601: JavaScript redirect
    public void jsRedirect(HttpServletResponse response, String destination) throws IOException {
        // Vulnerable: JavaScript redirect to user input
        response.getWriter().println("<script>");
        response.getWriter().println("window.location.href = '" + destination + "';");
        response.getWriter().println("</script>");
    }
    
    // CWE-601: Forward with user input
    public void forwardRequest(HttpServletRequest request, HttpServletResponse response) {
        String target = request.getParameter("target");
        try {
            // Vulnerable: forwarding to user-controlled path
            request.getRequestDispatcher(target).forward(request, response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
