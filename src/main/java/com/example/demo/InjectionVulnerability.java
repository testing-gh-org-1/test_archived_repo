package com.example.demo;

import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

// CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection')
public class InjectionVulnerability {
    
    // CWE-74: LDAP Injection
    public String ldapSearch(HttpServletRequest request) {
        String username = request.getParameter("username");
        try {
            Context ctx = new InitialContext();
            // Vulnerable: user input directly in LDAP query
            String filter = "(uid=" + username + ")";
            Object obj = ctx.lookup(filter);
            return "User found: " + obj.toString();
        } catch (NamingException e) {
            return "User not found";
        }
    }
    
    // CWE-74: XPath Injection
    public String xpathQuery(String userId) {
        try {
            javax.xml.xpath.XPathFactory xpathFactory = javax.xml.xpath.XPathFactory.newInstance();
            javax.xml.xpath.XPath xpath = xpathFactory.newXPath();
            
            // Vulnerable: user input in XPath expression
            String expression = "//users/user[@id='" + userId + "']";
            return expression;
        } catch (Exception e) {
            return null;
        }
    }
    
    // CWE-74: JavaScript/SpEL Injection
    public Object evaluateExpression(String userExpression) {
        try {
            // Vulnerable: evaluating user-provided expression
            ExpressionParser parser = new SpelExpressionParser();
            Expression exp = parser.parseExpression(userExpression);
            return exp.getValue();
        } catch (Exception e) {
            return "Error evaluating expression";
        }
    }
    
    // CWE-74: Script Engine Injection
    public String executeScript(HttpServletRequest request) {
        String script = request.getParameter("script");
        try {
            // Vulnerable: executing user-provided script
            ScriptEngineManager manager = new ScriptEngineManager();
            ScriptEngine engine = manager.getEngineByName("javascript");
            Object result = engine.eval(script);
            return result != null ? result.toString() : "null";
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
    
    // CWE-74: XML Injection
    public String createXMLResponse(String username, String email) {
        // Vulnerable: user input directly in XML without escaping
        StringBuilder xml = new StringBuilder();
        xml.append("<?xml version=\"1.0\"?>");
        xml.append("<user>");
        xml.append("<username>").append(username).append("</username>");
        xml.append("<email>").append(email).append("</email>");
        xml.append("</user>");
        return xml.toString();
    }
    
    // CWE-74: NoSQL Injection (MongoDB-like)
    public String buildMongoQuery(String username, String role) {
        // Vulnerable: building NoSQL query with user input
        String query = "{ username: '" + username + "', role: '" + role + "' }";
        return query;
    }
    
    // CWE-74: Log Injection
    public void logUserAction(HttpServletRequest request, java.util.logging.Logger logger) {
        String action = request.getParameter("action");
        String userId = request.getParameter("userId");
        
        // Vulnerable: user input in log message (can inject newlines)
        logger.info("User action: " + action + " by user: " + userId);
    }
    
    // CWE-74: JSON Injection
    public String createJSONResponse(String username, String status) {
        // Vulnerable: user input directly in JSON without proper escaping
        return "{\"username\": \"" + username + "\", \"status\": \"" + status + "\"}";
    }
    
    // CWE-74: Template Injection
    public String renderTemplate(String userName, String templateString) {
        // Vulnerable: user input in template
        String template = "Hello, " + userName + "! " + templateString;
        return template;
    }
    
    // CWE-74: Expression Language Injection
    public void processELExpression(HttpServletRequest request, HttpServletResponse response) throws IOException {
        String expression = request.getParameter("expr");
        
        // Vulnerable: evaluating user-provided EL expression
        try {
            javax.el.ExpressionFactory factory = javax.el.ExpressionFactory.newInstance();
            javax.el.ValueExpression ve = factory.createValueExpression(
                new javax.el.StandardELContext(factory), 
                "${" + expression + "}", 
                Object.class
            );
            Object result = ve.getValue(new javax.el.StandardELContext(factory));
            response.getWriter().println("Result: " + result);
        } catch (Exception e) {
            response.getWriter().println("Error: " + e.getMessage());
        }
    }
}
