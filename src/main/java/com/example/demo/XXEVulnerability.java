package com.example.demo;

import javax.xml.parsers.*;
import org.xml.sax.InputSource;
import org.w3c.dom.Document;
import java.io.StringReader;

// CWE-611: Improper Restriction of XML External Entity Reference
public class XXEVulnerability {
    
    // CWE-611: XXE in DocumentBuilder
    public Document parseXML(String xmlContent) {
        try {
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            // Vulnerable: external entities not disabled
            DocumentBuilder builder = factory.newDocumentBuilder();
            return builder.parse(new InputSource(new StringReader(xmlContent)));
        } catch (Exception e) {
            return null;
        }
    }
    
    // CWE-611: XXE in SAXParser
    public void parseSAX(String xmlContent) {
        try {
            SAXParserFactory factory = SAXParserFactory.newInstance();
            // Vulnerable: XXE not prevented
            SAXParser parser = factory.newSAXParser();
            parser.parse(new InputSource(new StringReader(xmlContent)), new org.xml.sax.helpers.DefaultHandler());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // CWE-611: XXE in XMLReader
    public void parseWithXMLReader(String xmlContent) {
        try {
            SAXParserFactory factory = SAXParserFactory.newInstance();
            SAXParser parser = factory.newSAXParser();
            // Vulnerable: XMLReader without security features
            org.xml.sax.XMLReader reader = parser.getXMLReader();
            reader.parse(new InputSource(new StringReader(xmlContent)));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // CWE-611: XXE in XPath
    public String evaluateXPath(String xmlContent, String xpathExpression) {
        try {
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            // Vulnerable: no XXE protection
            DocumentBuilder builder = factory.newDocumentBuilder();
            Document doc = builder.parse(new InputSource(new StringReader(xmlContent)));
            
            javax.xml.xpath.XPathFactory xpathFactory = javax.xml.xpath.XPathFactory.newInstance();
            javax.xml.xpath.XPath xpath = xpathFactory.newXPath();
            return xpath.evaluate(xpathExpression, doc);
        } catch (Exception e) {
            return null;
        }
    }
    
    // CWE-611: XXE in Transformer
    public void transformXML(String xmlContent) {
        try {
            javax.xml.transform.TransformerFactory factory = javax.xml.transform.TransformerFactory.newInstance();
            // Vulnerable: external entities allowed
            javax.xml.transform.Transformer transformer = factory.newTransformer();
            transformer.transform(
                new javax.xml.transform.stream.StreamSource(new StringReader(xmlContent)),
                new javax.xml.transform.stream.StreamResult(System.out)
            );
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
