package com.example.demo;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.sql.PreparedStatement;
import javax.servlet.http.HttpServletRequest;

// CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')
public class SQLInjectionVulnerability {
    
    private static final String DB_URL = "jdbc:mysql://localhost:3306/userdb";
    private static final String DB_USER = "root";
    private static final String DB_PASSWORD = "password";
    
    // CWE-89: Direct SQL injection in login
    public boolean authenticateUser(String username, String password) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: concatenating user input directly into SQL query
            String query = "SELECT * FROM users WHERE username='" + username + 
                          "' AND password='" + password + "'";
            ResultSet rs = stmt.executeQuery(query);
            
            boolean authenticated = rs.next();
            rs.close();
            stmt.close();
            conn.close();
            return authenticated;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }
    
    // CWE-89: SQL injection in search functionality
    public ResultSet searchUsers(HttpServletRequest request) {
        String searchTerm = request.getParameter("search");
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: user input in LIKE clause
            String query = "SELECT * FROM users WHERE name LIKE '%" + searchTerm + "%'";
            return stmt.executeQuery(query);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
    
    // CWE-89: SQL injection in ORDER BY clause
    public ResultSet getUsersSorted(String sortColumn) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: user-controlled ORDER BY
            String query = "SELECT * FROM users ORDER BY " + sortColumn;
            return stmt.executeQuery(query);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
    
    // CWE-89: SQL injection in DELETE statement
    public void deleteUser(String userId) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: user input in DELETE query
            String query = "DELETE FROM users WHERE id = " + userId;
            stmt.executeUpdate(query);
            
            stmt.close();
            conn.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // CWE-89: SQL injection in UPDATE statement
    public void updateUserEmail(String userId, String newEmail) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: concatenating user input in UPDATE
            String query = "UPDATE users SET email = '" + newEmail + "' WHERE id = " + userId;
            stmt.executeUpdate(query);
            
            stmt.close();
            conn.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // CWE-89: SQL injection with multiple conditions
    public ResultSet getFilteredUsers(String role, String department, String status) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: building complex query with user inputs
            StringBuilder query = new StringBuilder("SELECT * FROM users WHERE 1=1");
            if (role != null) {
                query.append(" AND role='").append(role).append("'");
            }
            if (department != null) {
                query.append(" AND department='").append(department).append("'");
            }
            if (status != null) {
                query.append(" AND status='").append(status).append("'");
            }
            
            return stmt.executeQuery(query.toString());
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
    
    // CWE-89: SQL injection in dynamic table name
    public ResultSet getDataFromTable(String tableName, String condition) {
        try {
            Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement stmt = conn.createStatement();
            
            // Vulnerable: user-controlled table name and condition
            String query = "SELECT * FROM " + tableName + " WHERE " + condition;
            return stmt.executeQuery(query);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}
