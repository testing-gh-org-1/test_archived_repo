package com.example.demo;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.servlet.http.Cookie;
import java.io.Serializable;
import java.io.ObjectInputStream;
import java.io.ByteArrayInputStream;
import java.util.Base64;

// CWE-502: Deserialization of Untrusted Data
public class InsecureDeserializationVulnerability {
    
    // CWE-502: Deserializing user input directly
    public Object deserializeObject(String serializedData) {
        try {
            byte[] data = Base64.getDecoder().decode(serializedData);
            // Vulnerable: deserializing untrusted data
            ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(data));
            return ois.readObject();
        } catch (Exception e) {
            return null;
        }
    }
    
    // CWE-502: Deserializing from cookie
    public Object deserializeFromCookie(HttpServletRequest request) {
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("userData".equals(cookie.getName())) {
                    // Vulnerable: deserializing cookie value
                    return deserializeObject(cookie.getValue());
                }
            }
        }
        return null;
    }
    
    // CWE-502: Deserializing from session
    public Object deserializeFromSession(HttpServletRequest request) {
        HttpSession session = request.getSession();
        String serializedData = (String) session.getAttribute("serializedData");
        
        if (serializedData != null) {
            // Vulnerable: deserializing session data
            return deserializeObject(serializedData);
        }
        return null;
    }
    
    // CWE-502: Deserializing from request parameter
    public void processSerializedData(HttpServletRequest request) {
        String data = request.getParameter("data");
        try {
            // Vulnerable: direct deserialization of user input
            byte[] bytes = Base64.getDecoder().decode(data);
            ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes));
            Object obj = ois.readObject();
            ois.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
