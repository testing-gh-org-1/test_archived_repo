package com.example.demo;

import java.io.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

// CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
public class PathTraversalVulnerability {
    
    private static final String BASE_DIR = "/var/www/files/";
    
    // CWE-22: Path traversal in file reading
    public String readFile(String filename) {
        try {
            // Vulnerable: no validation of filename
            File file = new File(BASE_DIR + filename);
            BufferedReader reader = new BufferedReader(new FileReader(file));
            StringBuilder content = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                content.append(line).append("\n");
            }
            reader.close();
            return content.toString();
        } catch (IOException e) {
            return "Error reading file";
        }
    }
    
    // CWE-22: Path traversal in file download
    public void downloadFile(HttpServletRequest request, HttpServletResponse response) {
        String filename = request.getParameter("file");
        try {
            // Vulnerable: user controls file path
            File file = new File("/downloads/" + filename);
            FileInputStream fis = new FileInputStream(file);
            OutputStream os = response.getOutputStream();
            
            byte[] buffer = new byte[1024];
            int bytesRead;
            while ((bytesRead = fis.read(buffer)) != -1) {
                os.write(buffer, 0, bytesRead);
            }
            fis.close();
            os.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    // CWE-22: Path traversal in file deletion
    public boolean deleteFile(String filepath) {
        // Vulnerable: no path validation
        File file = new File(filepath);
        return file.delete();
    }
    
    // CWE-22: Path traversal with File.separator
    public String readUserFile(String userId, String filename) {
        try {
            // Vulnerable: concatenating paths without validation
            String path = "/home/users/" + userId + File.separator + filename;
            BufferedReader reader = new BufferedReader(new FileReader(path));
            return reader.readLine();
        } catch (IOException e) {
            return null;
        }
    }
    
    // CWE-22: Path traversal in file upload
    public void saveUploadedFile(HttpServletRequest request, String filename) {
        try {
            // Vulnerable: filename from user input
            File destination = new File("/uploads/" + filename);
            InputStream input = request.getInputStream();
            FileOutputStream output = new FileOutputStream(destination);
            
            byte[] buffer = new byte[1024];
            int bytesRead;
            while ((bytesRead = input.read(buffer)) != -1) {
                output.write(buffer, 0, bytesRead);
            }
            output.close();
            input.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
